import type { ReactNode } from 'react'

import { clsx } from 'clsx'
import { compiler } from 'markdown-to-jsx'
import { useRef } from 'react'

import { hexToRgb } from '@/utils/theme'

import type { MarkdownTheme } from './theme/types'

import { SelectionPopup, useSelectionPopup } from './core'
import {
  Anchor,
  Blockquote,
  CodeBlock,
  CodeInline,
  Del,
  Em,
  H1,
  H2,
  H3,
  H4,
  H5,
  H6,
  Hr,
  Image,
  Li,
  Ol,
  Paragraph,
  Strong,
  Table,
  Tbody,
  Td,
  Th,
  Thead,
  Tr,
  Ul,
} from './renderers'
import { MarkdownThemeProvider } from './theme'
import { useMarkdownTheme } from './theme/useTheme'
import { Toc } from './toc'

interface MarkdownProps {
  accentColor?: string
  children?: string
  className?: string
  theme?: MarkdownTheme
  value?: string
}

/**
 * MarkdownInner：负责将 Markdown 文本编译为 React 节点并渲染到容器
 * - 使用 `markdown-to-jsx` 的 `compiler` 提供轻量编译能力
 * - 通过 `overrides` 将各 HTML 标签映射到自定义渲染组件
 * - 集成文本选择弹窗（复制）与右侧目录（TOC）
 */
const MarkdownInner = ({ accentColor, className, md }: { accentColor?: string; className?: string; md: string }) => {
  const theme = useMarkdownTheme()
  const containerRef = useRef<HTMLDivElement | null>(null)
  const { copy, onMouseUp, position, visible } = useSelectionPopup(containerRef)
  let style: React.CSSProperties | undefined
  if (accentColor) {
    const rgb = hexToRgb(accentColor)
    if (rgb) {
      const vars: Record<string, string> = {
        '--primary-color': accentColor,
        '--primary-color-rgb': `${rgb.r}, ${rgb.g}, ${rgb.b}`,
      }
      style = vars as unknown as React.CSSProperties
    }
  }
  return (
    <div className={clsx('relative md:grid md:grid-cols-[1fr_280px] md:gap-8', className)}>
      <div ref={containerRef} onMouseUp={onMouseUp} className={clsx(theme.container)} style={style}>
        {compiler(md, {
          overrides: {
            a: Anchor,
            blockquote: Blockquote,
            code: CodeInline,
            del: Del,
            em: Em,
            h1: H1,
            h2: H2,
            h3: H3,
            h4: H4,
            h5: H5,
            h6: H6,
            hr: Hr,
            img: Image,
            li: Li,
            ol: Ol,
            p: Paragraph,
            pre: CodeBlock,
            strong: Strong,
            table: Table,
            tbody: Tbody,
            td: Td,
            th: Th,
            thead: Thead,
            tr: Tr,
            ul: Ul,
          },
        })}
        <SelectionPopup visible={visible} position={position} onCopy={copy} />
      </div>
      <div className="hidden md:block">
        <Toc containerRef={containerRef} />
      </div>
    </div>
  )
}

/**
 * 外层 Markdown 组件：提供主题上下文并包裹编译渲染
 * - `value` 优先；若未传入则回退到 `children`
 * - 支持传入自定义主题 `MarkdownTheme`，否则使用默认主题
 */
export function Markdown({ accentColor, children, className, theme, value }: MarkdownProps): ReactNode {
  const md = value ?? children ?? ''
  return (
    <MarkdownThemeProvider theme={theme}>
      <MarkdownInner accentColor={accentColor} className={className} md={md} />
    </MarkdownThemeProvider>
  )
}
